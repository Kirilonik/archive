# Архитектура базы данных

## Обзор

База данных разделена на две части:
1. **Каталог** - общие данные о фильмах, сериалах, сезонах и эпизодах (не зависят от пользователя)
2. **Пользовательские данные** - личные оценки, мнения и статусы просмотра пользователей

## Преимущества такой архитектуры

1. **Отсутствие дублирования**: Данные о сериалах, сезонах и эпизодах хранятся один раз в каталоге
2. **Эффективность**: При добавлении сериала пользователем проверяется наличие в каталоге, если есть - создается только связь
3. **Единообразие**: Все пользователи видят одинаковую информацию о сериалах (название, описание, постер)
4. **Гибкость**: Каждый пользователь может иметь свои оценки, мнения и статусы просмотра
5. **Масштабируемость**: Легко добавлять новых пользователей без дублирования данных

## Структура таблиц

### Каталог (общие данные)

#### `films_catalog`
Общий каталог фильмов. Содержит информацию, полученную с Кинопоиска.
- `id` - первичный ключ
- `kp_id` - уникальный ID с Кинопоиска (UNIQUE)
- `title`, `poster_url`, `rating`, `year`, `description` - основная информация
- `director`, `budget`, `revenue`, `genres`, `actors` - дополнительная информация

#### `series_catalog`
Общий каталог сериалов. Аналогична структуре `films_catalog`.
- `id` - первичный ключ
- `kp_id` - уникальный ID с Кинопоиска (UNIQUE)
- Все поля аналогичны `films_catalog`

#### `seasons_catalog`
Общий каталог сезонов. Привязан к сериалу из каталога.
- `id` - первичный ключ
- `series_catalog_id` - ссылка на сериал из каталога
- `number` - номер сезона
- UNIQUE(series_catalog_id, number) - один сезон с одним номером на сериал

#### `episodes_catalog`
Общий каталог эпизодов. Привязан к сезону из каталога.
- `id` - первичный ключ
- `season_catalog_id` - ссылка на сезон из каталога
- `number` - номер эпизода
- `title`, `release_date`, `duration` - информация об эпизоде
- UNIQUE(season_catalog_id, number) - один эпизод с одним номером на сезон

### Пользовательские данные

#### `user_films`
Связь пользователя с фильмом. Содержит личные данные пользователя.
- `id` - первичный ключ
- `user_id` - ссылка на пользователя
- `film_catalog_id` - ссылка на фильм из каталога
- `my_rating` - личная оценка пользователя (0-10)
- `opinion` - личное мнение пользователя (markdown)
- `status` - статус просмотра
- UNIQUE(user_id, film_catalog_id) - один пользователь может иметь только одну запись о фильме

#### `user_series`
Связь пользователя с сериалом. Аналогична структуре `user_films`.
- `id` - первичный ключ
- `user_id` - ссылка на пользователя
- `series_catalog_id` - ссылка на сериал из каталога
- `my_rating`, `opinion`, `status` - личные данные пользователя
- UNIQUE(user_id, series_catalog_id)

#### `user_seasons`
Статус просмотра сезона пользователем.
- `id` - первичный ключ
- `user_id` - ссылка на пользователя
- `season_catalog_id` - ссылка на сезон из каталога
- `watched` - просмотрен ли сезон
- UNIQUE(user_id, season_catalog_id)

#### `user_episodes`
Статус просмотра эпизода пользователем.
- `id` - первичный ключ
- `user_id` - ссылка на пользователя
- `episode_catalog_id` - ссылка на эпизод из каталога
- `watched` - просмотрен ли эпизод
- UNIQUE(user_id, episode_catalog_id)

## Логика работы

### Добавление фильма/сериала пользователем

1. Проверяется наличие в каталоге по `kp_id` (если передан) или по `title + year`
2. Если не найден - создается запись в каталоге
3. Создается связь в `user_films` или `user_series`
4. Если это сериал - автоматически создаются сезоны и эпизоды в каталоге (если их еще нет)

### Получение списка фильмов/сериалов пользователя

```sql
SELECT 
  fc.*,
  uf.my_rating,
  uf.opinion,
  uf.status
FROM user_films uf
JOIN films_catalog fc ON uf.film_catalog_id = fc.id
WHERE uf.user_id = $1
```

### Получение сезонов и эпизодов сериала пользователя

```sql
-- Сезоны
SELECT 
  sc.*,
  us.watched as user_watched
FROM seasons_catalog sc
LEFT JOIN user_seasons us ON sc.id = us.season_catalog_id AND us.user_id = $1
WHERE sc.series_catalog_id = $2

-- Эпизоды
SELECT 
  ec.*,
  ue.watched as user_watched
FROM episodes_catalog ec
LEFT JOIN user_episodes ue ON ec.id = ue.episode_catalog_id AND ue.user_id = $1
WHERE ec.season_catalog_id = $2
```

## План миграции данных

1. **Создание новой структуры** - выполнить миграцию `014_refactor_to_catalog_architecture.sql`
2. **Миграция данных**:
   - Объединить дубликаты фильмов/сериалов по `kp_id` или `title + year`
   - Создать записи в каталогах
   - Создать связи в пользовательских таблицах
   - Перенести статусы просмотра
3. **Обновление кода**:
   - Обновить все сервисы для работы с новой структурой
   - Обновить API endpoints
   - Обновить клиентскую часть
4. **Удаление старых таблиц** (после проверки):
   - `films`, `series`, `seasons`, `episodes`

## Индексы

Все таблицы имеют индексы на:
- Внешние ключи (для быстрых JOIN)
- `kp_id` в каталогах (для быстрого поиска)
- `title` в каталогах (для поиска по названию)
- Составные индексы на UNIQUE ограничения

