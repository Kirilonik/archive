name: CI/CD Pipeline

on:
  push:
    branches: [main]
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é

jobs:
  ci:
    name: Build & Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build server
        run: npm run build --workspace server

      - name: Build client
        run: npm run build --workspace client

      - name: Check build artifacts
        run: |
          test -d server/dist && echo "‚úÖ Server build successful"
          test -d client/dist && echo "‚úÖ Client build successful"

  deploy:
    name: Deploy to Production
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_SSH_PORT || 22 }}
          script: |
            set -e  # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

            echo "üöÄ –ù–∞—á–∞–ª–æ –¥–µ–ø–ª–æ—è..."
            echo "üì¶ –ö–æ–º–º–∏—Ç: ${{ github.sha }}"
            echo "üë§ –ê–≤—Ç–æ—Ä: ${{ github.actor }}"

            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd /opt/media-archive/archive || { echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"; exit 1; }

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â—É—é –≤–µ—Ç–∫—É
            CURRENT_BRANCH=$(git branch --show-current)
            echo "üìç –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $CURRENT_BRANCH"

            # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
            echo "üì• –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
            git fetch origin main || { echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–π"; exit 1; }

            # –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ main –∏ –æ–±–Ω–æ–≤–ª—è–µ–º
            git checkout main || { echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ main"; exit 1; }
            git pull origin main || { echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–¥–∞"; exit 1; }

            echo "‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω"

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ docker-compose.prod.yml
            if [ ! -f "docker-compose.prod.yml" ]; then
              echo "‚ùå –§–∞–π–ª docker-compose.prod.yml –Ω–µ –Ω–∞–π–¥–µ–Ω"
              exit 1
            fi

            # Zero-downtime deployment: —Å–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã –ë–ï–ó –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "üî® –°–±–æ—Ä–∫–∞ –Ω–æ–≤—ã—Ö –æ–±—Ä–∞–∑–æ–≤ (—Å—Ç–∞—Ä—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø—Ä–æ–¥–æ–ª–∂–∞—é—Ç —Ä–∞–±–æ—Ç–∞—Ç—å)..."
            docker compose -f docker-compose.prod.yml build --pull || {
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±–æ—Ä–∫–µ –æ–±—Ä–∞–∑–æ–≤";
              exit 1;
            }

            # Rolling update: –æ–±–Ω–æ–≤–ª—è–µ–º server —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π health
            echo "üîÑ Rolling update: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ server (zero-downtime)..."
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º --force-recreate —á—Ç–æ–±—ã –ø–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–∞–∂–µ –µ—Å–ª–∏ –∏–º—è –∑–∞–Ω—è—Ç–æ
            docker compose -f docker-compose.prod.yml up -d --no-deps --remove-orphans --force-recreate server || {
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ server";
              docker compose -f docker-compose.prod.yml logs server --tail=50;
              exit 1;
            }

            # –ñ–¥–µ–º –ø–æ–∫–∞ –Ω–æ–≤—ã–π server —Å—Ç–∞–Ω–µ—Ç healthy
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –Ω–æ–≤–æ–≥–æ server..."
            # –î–∞–µ–º –≤—Ä–µ–º—è —Å–µ—Ä–≤–µ—Ä—É –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è
            sleep 5

            SERVER_HEALTHY=0
            for i in {1..40}; do
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ health endpoint (–æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
              if curl -f -s http://localhost:4000/api/health > /dev/null 2>&1; then
                echo "‚úÖ –ù–æ–≤—ã–π server –≥–æ—Ç–æ–≤ (–ø–æ–ø—ã—Ç–∫–∞ $i)"
                SERVER_HEALTHY=1
                break
              fi
              if [ $((i % 5)) -eq 0 ]; then
                echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ health server... (–ø–æ–ø—ã—Ç–∫–∞ $i/40)"
              fi
              sleep 2
            done

            if [ $SERVER_HEALTHY -eq 0 ]; then
              echo "‚ùå –ù–æ–≤—ã–π server –Ω–µ –ø—Ä–æ—à–µ–ª health check –ø–æ—Å–ª–µ 40 –ø–æ–ø—ã—Ç–æ–∫"
              echo "üìã –õ–æ–≥–∏ server:"
              docker compose -f docker-compose.prod.yml logs server --tail=50
              echo "üìä –°—Ç–∞—Ç—É—Å server:"
              docker compose -f docker-compose.prod.yml ps server
              echo "üîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ health endpoint –Ω–∞–ø—Ä—è–º—É—é:"
              curl -v http://localhost:4000/api/health || true
              exit 1
            fi

            # –û–±–Ω–æ–≤–ª—è–µ–º client –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ server –≥–æ—Ç–æ–≤
            echo "üîÑ Rolling update: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ client..."
            docker compose -f docker-compose.prod.yml up -d --no-deps --remove-orphans client || {
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ client";
              docker compose -f docker-compose.prod.yml logs client --tail=50;
              exit 1;
            }

            # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
            echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤..."
            docker image prune -f || true

            # –ñ–¥–µ–º –ø–æ–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –∑–∞–ø—É—Å—Ç—è—Ç—Å—è
            echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤..."
            sleep 15

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
            echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
            docker compose -f docker-compose.prod.yml ps

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∑–¥–æ—Ä–æ–≤—å–µ —Å–µ—Ä–≤–∏—Å–æ–≤
            echo "üè• –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–æ–≤..."

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ä–≤–µ—Ä (–∏–∑–≤–Ω–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —Ç–∞–∫ –Ω–∞–¥–µ–∂–Ω–µ–µ)
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞..."
            SERVER_HEALTHY=false
            for i in {1..10}; do
              if curl -f -s http://localhost:4000/api/health > /dev/null 2>&1; then
                echo "‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ–ø—ã—Ç–∫–∞ $i)"
                SERVER_HEALTHY=true
                break
              else
                echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞... (–ø–æ–ø—ã—Ç–∫–∞ $i/10)"
                sleep 3
              fi
            done

            if [ "$SERVER_HEALTHY" = false ]; then
              echo "‚ùå –°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –ø–æ—Å–ª–µ 10 –ø–æ–ø—ã—Ç–æ–∫"
              echo "üìã –õ–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:"
              docker compose -f docker-compose.prod.yml logs server --tail=50
              echo "üìã –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤:"
              docker compose -f docker-compose.prod.yml ps
              exit 1
            fi

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª–∏–µ–Ω—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞..."
            if curl -f -s http://localhost:8080/ > /dev/null 2>&1; then
              echo "‚úÖ –ö–ª–∏–µ–Ω—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç"
            else
              echo "‚ö†Ô∏è –ö–ª–∏–µ–Ω—Ç –µ—â–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ)"
            fi

            echo "üéâ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω!"
            echo "üìù –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞:"
            docker compose -f docker-compose.prod.yml logs server --tail=20

      - name: Deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ –î–µ–ø–ª–æ–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω"
          else
            echo "‚ùå –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–∏–ª—Å—è —Å –æ—à–∏–±–∫–æ–π"
            exit 1
          fi
