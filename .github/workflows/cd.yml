name: CD Pipeline

on:
  workflow_run:
    workflows: ['CI Pipeline']
    types:
      - completed
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  DEPLOY_PATH: /opt/media-archive/archive

jobs:
  # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ CI –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ
  check-ci:
    name: Check CI Status
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Verify CI passed
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" != "success" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "‚ùå CI Pipeline did not pass. Deployment cancelled."
            exit 1
          fi
          echo "‚úÖ CI Pipeline passed. Proceeding with deployment."

  # –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: check-ci
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Set default SSH port
        id: ssh_port
        run: |
          if [ -z "${{ secrets.VPS_SSH_PORT }}" ]; then
            echo "port=22" >> $GITHUB_OUTPUT
          else
            echo "port=${{ secrets.VPS_SSH_PORT }}" >> $GITHUB_OUTPUT
          fi

      - name: Set default URLs
        id: urls
        run: |
          API_URL="${{ secrets.API_BASE_URL }}"
          FRONTEND_URL="${{ secrets.FRONTEND_URL }}"
          if [ -z "$API_URL" ]; then
            echo "api_url=http://localhost:4000" >> $GITHUB_OUTPUT
          else
            echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          fi
          if [ -z "$FRONTEND_URL" ]; then
            echo "frontend_url=http://localhost:8080" >> $GITHUB_OUTPUT
          else
            echo "frontend_url=$FRONTEND_URL" >> $GITHUB_OUTPUT
          fi

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ steps.ssh_port.outputs.port }} -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Display deployment info
        run: |
          echo "üöÄ Starting deployment..."
          echo "üì¶ Branch: ${{ github.ref_name }}"
          echo "üîñ Commit: ${{ github.sha }}"
          echo "üë§ Author: ${{ github.actor }}"
          echo "üåê Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "üìç Server: ${{ secrets.VPS_HOST }}"

      - name: Deploy to server
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ steps.ssh_port.outputs.port }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
        run: |
          ssh -p $VPS_SSH_PORT $VPS_USER@$VPS_HOST << ENDSSH
            set -e
            echo "üìÇ Navigating to project directory..."
            cd $DEPLOY_PATH || { echo "‚ùå Directory not found: $DEPLOY_PATH"; exit 1; }

            echo "üì• Fetching latest changes..."
            git fetch origin

            echo "üîÑ Checking out branch: ${{ github.ref_name }}"
            BRANCH_NAME="${{ github.ref_name }}"
            git checkout \$BRANCH_NAME || git checkout -b \$BRANCH_NAME origin/\$BRANCH_NAME

            echo "‚¨áÔ∏è Pulling latest code..."
            git pull origin \$BRANCH_NAME

            echo "üìã Current commit: $(git rev-parse HEAD)"
            echo "üìù Commit message: $(git log -1 --pretty=%B)"

            echo "üìä Checking disk space..."
            df -h / || true
            df -h /var/lib/docker || true

            echo "üîß Checking Docker daemon status..."
            docker info > /dev/null 2>&1 || {
              echo "‚ö†Ô∏è Docker daemon issue detected, attempting to restart..."
              sudo systemctl restart docker || true
              sleep 5
            }

            echo "üî® Building new images (old containers continue running)..."
            # –°–æ–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã –ë–ï–ó –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å—Ç–∞—Ä—ã—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è zero-downtime
            MAX_BUILD_RETRIES=3
            BUILD_RETRY=0
            while [ $BUILD_RETRY -lt $MAX_BUILD_RETRIES ]; do
              if docker compose -f docker-compose.prod.yml build --pull; then
                echo "‚úÖ Build successful"
                break
              else
                BUILD_RETRY=$((BUILD_RETRY + 1))
                if [ $BUILD_RETRY -lt $MAX_BUILD_RETRIES ]; then
                  echo "‚ö†Ô∏è Build failed, retrying... ($BUILD_RETRY/$MAX_BUILD_RETRIES)"
                  sleep 10
                else
                  echo "‚ùå Build failed after $MAX_BUILD_RETRIES attempts"
                  docker compose -f docker-compose.prod.yml logs || true
                  exit 1
                fi
              fi
            done

            echo "üîÑ Rolling update: Updating server (zero-downtime)..."
            # –û–±–Ω–æ–≤–ª—è–µ–º server —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π health - —Å—Ç–∞—Ä—ã–π –ø—Ä–æ–¥–æ–ª–∂–∏—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ–∫–∞ –Ω–æ–≤—ã–π –Ω–µ —Å—Ç–∞–Ω–µ—Ç healthy
            docker compose -f docker-compose.prod.yml up -d --no-deps server
            
            echo "‚è≥ Waiting for new server to be healthy..."
            MAX_HEALTH_RETRIES=30
            HEALTH_RETRY=0
            SERVER_HEALTHY=false
            while [ $HEALTH_RETRY -lt $MAX_HEALTH_RETRIES ]; do
              if docker compose -f docker-compose.prod.yml ps server | grep -q "healthy\|Up"; then
                # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ health endpoint
                if curl -f -s http://localhost:4000/api/health > /dev/null 2>&1; then
                  echo "‚úÖ New server is healthy"
                  SERVER_HEALTHY=true
                  break
                fi
              fi
              HEALTH_RETRY=$((HEALTH_RETRY + 1))
              echo "‚è≥ Waiting for server health... ($HEALTH_RETRY/$MAX_HEALTH_RETRIES)"
              sleep 2
            done

            if [ "$SERVER_HEALTHY" != "true" ]; then
              echo "‚ùå New server failed to become healthy, rolling back..."
              docker compose -f docker-compose.prod.yml up -d --no-deps server || true
              exit 1
            fi

            echo "üîÑ Rolling update: Updating client..."
            # –û–±–Ω–æ–≤–ª—è–µ–º client –ø–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ server –≥–æ—Ç–æ–≤
            docker compose -f docker-compose.prod.yml up -d --no-deps client

            echo "‚è≥ Waiting for new client to be healthy..."
            sleep 5

            echo "üßπ Cleaning up old images (after successful deployment)..."
            # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –æ–±—Ä–∞–∑—ã —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è
            docker image prune -f || true
          ENDSSH

      - name: Health check
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ steps.ssh_port.outputs.port }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
          API_URL: ${{ steps.urls.outputs.api_url }}
          FRONTEND_URL: ${{ steps.urls.outputs.frontend_url }}
        run: |
          echo "üè• Performing health checks..."

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
          ssh -p $VPS_SSH_PORT $VPS_USER@$VPS_HOST << ENDSSH
            set -e
            echo "üìÇ Navigating to project directory..."
            cd $DEPLOY_PATH || { echo "‚ùå Directory not found: $DEPLOY_PATH"; exit 1; }

            echo "üìä Container status:"
            docker compose -f docker-compose.prod.yml ps

            echo "üîç Checking container health..."
            MAX_RETRIES=10
            RETRY_COUNT=0

            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if docker compose -f docker-compose.prod.yml ps | grep -q "healthy\|Up"; then
                echo "‚úÖ Containers are running"
                break
              fi
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "‚è≥ Waiting for containers... ($RETRY_COUNT/$MAX_RETRIES)"
              sleep 5
            done

            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "‚ùå Containers failed to start properly"
              docker compose -f docker-compose.prod.yml logs --tail=50
              exit 1
            fi
          ENDSSH

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ API
          echo "üîå Checking API health endpoint..."
          API_HEALTH_URL="${API_URL}/api/health"
          MAX_RETRIES=15
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s "$API_HEALTH_URL" > /dev/null 2>&1; then
              echo "‚úÖ API health check passed"
              curl -s "$API_HEALTH_URL" || echo "Health check response received"
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚è≥ Waiting for API... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 3
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "‚ùå API health check failed"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
          echo "üåê Checking frontend..."
          MAX_RETRIES=10
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s "$FRONTEND_URL" > /dev/null 2>&1; then
              echo "‚úÖ Frontend is accessible"
              break
            fi
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "‚è≥ Waiting for frontend... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 3
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "‚ö†Ô∏è Frontend check failed (non-critical)"
          fi

      - name: Deployment summary
        if: always()
        run: |
          echo "## üöÄ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Status** | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Environment** | ${{ github.event.inputs.environment || 'production' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch** | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Author** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Time** | $(date -u +'%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ **Deployment completed successfully**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "üåê **Frontend**: ${{ steps.urls.outputs.frontend_url }}" >> $GITHUB_STEP_SUMMARY
            echo "üîå **API**: ${{ steps.urls.outputs.api_url }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Deployment failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Rollback on failure
        if: failure()
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_SSH_PORT: ${{ steps.ssh_port.outputs.port }}
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}
        run: |
          echo "‚ö†Ô∏è Deployment failed. Attempting rollback..."
          ssh -p $VPS_SSH_PORT $VPS_USER@$VPS_HOST << ENDSSH || true
            set -e
            cd $DEPLOY_PATH || { echo "‚ùå Directory not found: $DEPLOY_PATH"; exit 1; }
            echo "üîÑ Rolling back to previous commit..."
            git reset --hard HEAD~1 || git reset --hard origin/${{ github.ref_name }} || true
            echo "üî® Rebuilding containers..."
            docker compose -f docker-compose.prod.yml up -d --build || true
            echo "‚úÖ Rollback completed"
          ENDSSH

  # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: deploy
    if: always()

    steps:
      - name: Set default URLs
        id: urls
        run: |
          API_URL="${{ secrets.API_BASE_URL }}"
          if [ -z "$API_URL" ]; then
            echo "api_url=http://localhost:4000" >> $GITHUB_OUTPUT
          else
            echo "api_url=$API_URL" >> $GITHUB_OUTPUT
          fi

      - name: Calculate deployment duration
        id: duration
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –¥–µ–ø–ª–æ—è –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ job
          # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å, –æ—Å—Ç–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–º
          echo "duration=" >> $GITHUB_OUTPUT

      - name: Send Telegram notification
        env:
          API_URL: ${{ steps.urls.outputs.api_url }}
          DEPLOY_SECRET: ${{ secrets.TELEGRAM_DEPLOY_SECRET }}
        run: |
          STATUS="${{ needs.deploy.result }}"
          ENVIRONMENT="${{ github.event.inputs.environment || 'production' }}"

          if [ -z "$DEPLOY_SECRET" ]; then
            echo "‚ö†Ô∏è TELEGRAM_DEPLOY_SECRET is not set. Skipping Telegram notification."
            exit 0
          fi

          if [ -z "$API_URL" ]; then
            echo "‚ö†Ô∏è API_BASE_URL is not set. Skipping Telegram notification."
            exit 0
          fi

          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ API
          curl -X POST "$API_URL/api/telegram/deploy" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $DEPLOY_SECRET" \
            -d "{
              \"status\": \"$STATUS\",
              \"branch\": \"${{ github.ref_name }}\",
              \"commit\": \"${{ github.sha }}\",
              \"author\": \"${{ github.actor }}\",
              \"environment\": \"$ENVIRONMENT\"
            }" \
            --fail-with-body \
            --silent \
            --show-error || echo "‚ö†Ô∏è Failed to send Telegram notification (non-critical)"
