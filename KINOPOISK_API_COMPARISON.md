# Сравнение API Кинопоиска

## Текущий API: kinopoiskapiunofficial.tech

### Используемые методы и эндпоинты:

1. **suggest** (поиск для автодополнения)
   - Эндпоинт: `GET /api/v2.1/films/search-by-keyword?keyword={query}&page=1`
   - Возвращает: массив фильмов/сериалов для автодополнения

2. **searchBestByTitle** (поиск лучшего совпадения по названию)
   - Эндпоинт: `GET /api/v2.1/films/search-by-keyword?keyword={title}&page=1`
   - Возвращает: первый результат поиска + детали через `fetchFilmDetails`

3. **fetchFilmDetails** (детали фильма/сериала)
   - Эндпоинт: `GET /api/v2.2/films/{kpId}`
   - Дополнительно вызывает:
     - `GET /api/v1/staff?filmId={kpId}` - актеры и режиссеры
     - `GET /api/v2.2/films/{kpId}/box_office` - бюджет
   - Возвращает: полную информацию о фильме

4. **fetchSeriesDetails** (сезоны и эпизоды сериала)
   - Эндпоинт: `GET /api/v2.2/films/{kpId}/seasons`
   - Возвращает: структуру сезонов с эпизодами

5. **fetchFilmImages** (изображения фильма)
   - Эндпоинт: `GET /api/v2.2/films/{kpId}/images?type={type}&page={page}`
   - Типы: `STILL`, `SHOOTING`, `POSTER`, `FAN_ART`, `PROMO`, `CONCEPT`, `WALLPAPER`, `COVER`, `SCREENSHOT`
   - Возвращает: массив изображений с пагинацией

### Авторизация:
- Заголовок: `X-API-KEY: {key}`

---

## Новый API: api.kinopoiskapi.uz

### Базовая информация:
- Базовый URL: `https://api.kinopoiskapi.uz/v1/`
- Авторизация: `Authorization: Bearer {token}`
- Токен получается через бота: @kinopoiskapiuz_bot

### ✅ Найденные эндпоинты:

1. **Поиск фильмов/сериалов** ✅
   - `GET /v1/kinopoisk/movie/search?name={query}&page=1&limit=10`
   - Ищет по `name_ru` и `name_eng`
   - Возвращает пагинированный список фильмов

2. **Детали фильма/сериала** ✅
   - `GET /v1/kinopoisk/movie/{id}`
   - Возвращает полную информацию о фильме/сериале
   - Включает: описание, жанры, год, рейтинги (Kinopoisk и IMDb), постер, трейлер, страны, студии

3. **Актеры и режиссеры** ✅
   - Встроены в ответ `/v1/kinopoisk/movie/{id}` как массивы:
     - `actors` - массив Participant
     - `directors` - массив Participant
     - Также есть: `screenwriters`, `producers`, `operators`, `composers`, `editors`
   - Дополнительно: `GET /v1/kinopoisk/participant/search` - поиск участника по имени
   - Дополнительно: `GET /v1/kinopoisk/movie/participant?participant_id={id}` - фильмы участника

4. **Сезоны и эпизоды сериала** ⚠️
   - Поле `seasons` присутствует в ответе `/v1/kinopoisk/movie/{id}`
   - **ПРОБЛЕМА**: `seasons` определен как `string`, а не как массив объектов
   - Возможно, это JSON-строка, которую нужно парсить
   - **Нет отдельного эндпоинта** для получения детальной структуры сезонов

5. **Изображения** ❌
   - **НЕТ отдельного эндпоинта** для получения изображений
   - Есть только поле `poster` (один постер)
   - Возможно, есть поле `additional` (объект), но структура неясна
   - **НЕТ поддержки**: кадры (STILL), концепт-арт (CONCEPT), постеры (POSTER), обои (WALLPAPER) и т.д.

6. **Бюджет и кассовые сборы** ❌
   - **НЕТ эндпоинта** для получения бюджета
   - Возможно, есть в поле `additional`, но не гарантировано

### Дополнительные возможности нового API:

- **Фильтрация фильмов**: `GET /v1/kinopoisk/movie/filter` - мощный поиск с фильтрами по:
  - Году, рейтингам, жанрам, странам, возрастным ограничениям
  - Датам премьер, студиям
  - Сортировка по различным полям
  
- **Поиск по наградам**: `GET /v1/kinopoisk/movie/award` - поиск фильмов по наградам (Оскар, Золотой глобус и т.д.)

- **Списки значений**: `GET /v1/kinopoisk/list/values_by_filter_fields` - получение списков стран, жанров, коллекций, студий, наград

---

## План миграции

### Шаг 1: Проверка документации
- [ ] Открыть https://api.kinopoiskapi.uz/documentation/
- [ ] Авторизоваться с Bearer токеном
- [ ] Проверить наличие всех необходимых эндпоинтов
- [ ] Проверить структуру ответов API

### Шаг 2: Сравнение структур данных
- [ ] Сравнить структуру ответа поиска
- [ ] Сравнить структуру деталей фильма
- [ ] Сравнить структуру сезонов/эпизодов
- [ ] Сравнить структуру изображений

### Шаг 3: Адаптация кода
- [ ] Изменить базовый URL
- [ ] Изменить метод авторизации (X-API-KEY → Bearer)
- [ ] Адаптировать эндпоинты под новую версию API
- [ ] Адаптировать маппинг данных под новую структуру ответов

### Шаг 4: Тестирование
- [ ] Протестировать поиск (suggest)
- [ ] Протестировать поиск по названию (searchBestByTitle)
- [ ] Протестировать получение деталей фильма
- [ ] Протестировать получение сезонов сериала
- [ ] Протестировать получение изображений

---

## Потенциальные проблемы

1. **❌ КРИТИЧНО: Нет эндпоинта для изображений**
   - Текущий API: `/api/v2.2/films/{id}/images?type={type}&page={page}`
   - Новый API: только поле `poster` (один постер)
   - **Проблема**: Невозможно получить кадры, концепт-арт, постеры, обои
   - **Решение**: Либо использовать только постер, либо искать альтернативные источники

2. **⚠️ ПРОБЛЕМА: Структура сезонов**
   - Текущий API: `/api/v2.2/films/{id}/seasons` возвращает структурированные данные
   - Новый API: поле `seasons` определено как `string`, возможно JSON-строка
   - **Проблема**: Неясно, как парсить сезоны и эпизоды
   - **Решение**: Нужно протестировать реальный ответ API

3. **❌ Нет бюджета**
   - Текущий API: `/api/v2.2/films/{id}/box_office` возвращает бюджет
   - Новый API: нет эндпоинта для бюджета
   - **Проблема**: Потеря функциональности
   - **Решение**: Можно сделать опциональным полем

4. **Разные структуры данных**
   - Новый API использует другие названия полей:
     - `kp_id` вместо `kinopoiskId`
     - `name_ru` / `name_eng` вместо `nameRu` / `nameEn`
     - `year_production` вместо `year`
     - `is_serial` вместо `type === 'TV_SERIES'`
     - `kino_poisk_rating` вместо `ratingKinopoisk`
   - **Решение**: Создать адаптер для преобразования данных

5. **Разный формат поиска**
   - Текущий API: `search-by-keyword` возвращает массив в `films`
   - Новый API: `movie/search` возвращает пагинированный ответ
   - **Решение**: Адаптировать парсинг ответа

6. **Ограничения по запросам**
   - Новый API может иметь другие лимиты rate limiting
   - Нужно проверить условия использования в боте

7. **Стабильность API**
   - Новый API может быть менее стабильным
   - Нужно протестировать на практике

---

## Рекомендации

### ⚠️ ВАЖНО: Перед миграцией нужно решить проблемы

1. **Изображения** - критическая проблема
   - Если нужны кадры, концепт-арт, постеры - новый API не подходит
   - Можно использовать только постер из поля `poster`
   - Или искать альтернативные источники изображений

2. **Сезоны** - нужно протестировать
   - Проверить реальный формат поля `seasons`
   - Если это JSON-строка - добавить парсинг
   - Если структура не подходит - возможно, API не готов для сериалов

3. **Бюджет** - опционально
   - Можно сделать опциональным полем
   - Или убрать функциональность

### План действий:

1. **Протестировать новый API вручную** через документацию:
   - Получить токен через бота @kinopoiskapiuz_bot
   - Протестировать поиск: `GET /v1/kinopoisk/movie/search?name=Голяк`
   - Протестировать детали: `GET /v1/kinopoisk/movie/{id}` (например, ID известного фильма)
   - Проверить формат поля `seasons` для сериала
   - Проверить структуру поля `additional`

2. **Создать тестовую реализацию** с адаптером данных:
   - Реализовать маппинг полей старого API → нового API
   - Обработать отсутствующие поля (изображения, бюджет)
   - Протестировать все методы: suggest, searchBestByTitle, fetchFilmDetails, fetchSeriesDetails

3. **Сохранить возможность отката**:
   - Добавить feature flag `KINOPOISK_API_PROVIDER` (old/new)
   - Сохранить старую реализацию
   - Переключаться через переменную окружения

4. **Оценить потери функциональности**:
   - Если изображения критичны - возможно, стоит остаться на старом API
   - Если можно обойтись только постером - миграция возможна

