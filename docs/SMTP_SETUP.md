# Настройка SMTP для отправки email

Для работы системы подтверждения email необходимо настроить SMTP сервер. В этой инструкции описаны варианты настройки.

## Вариант 1: Gmail (рекомендуется) ⭐

Gmail надежно работает и редко блокирует письма как спам. Рекомендуется для продакшна.

### Шаги настройки:

1. **Включите двухфакторную аутентификацию (2FA)** в Google аккаунте:
   - Откройте https://myaccount.google.com/security
   - Найдите раздел "Двухэтапная аутентификация"
   - Включите 2FA, если еще не включена (обязательно!)

2. **Создайте пароль приложения**:
   - Откройте https://myaccount.google.com/apppasswords
   - Если не видите эту страницу, убедитесь что 2FA включена
   - Выберите "Почта" в первом выпадающем списке
   - Выберите "Другое устройство" во втором списке
   - Введите название: "Media Archive SMTP"
   - Нажмите "Создать"
   - **Скопируйте 16-символьный пароль** (показывается только один раз!)

3. **Настройте переменные окружения**:

```bash
# SMTP настройки для Gmail
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=ваш_email@gmail.com
SMTP_PASSWORD=пароль_приложения_16_символов
SMTP_FROM=ваш_email@gmail.com

# Пример:
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false
SMTP_USER=myapp@gmail.com
SMTP_PASSWORD=abcd efgh ijkl mnop  # Без пробелов! Должно быть 16 символов подряд
SMTP_FROM=myapp@gmail.com
```

### Важные моменты:

- ✅ **Обязательно включите 2FA** перед созданием пароля приложения
- ✅ Используйте **пароль приложения**, а не обычный пароль аккаунта
- ✅ Порт 587 с `SMTP_SECURE=false` (STARTTLS) - рекомендуется
- ✅ Альтернатива: порт 465 с `SMTP_SECURE=true` (SSL)
- ✅ Отправитель (SMTP_FROM) должен совпадать с SMTP_USER
- ✅ Пароль приложения показывается только один раз - сохраните его!

### Преимущества Gmail:

- ✅ Надежная доставка писем
- ✅ Редко блокирует как спам
- ✅ Работает по всему миру
- ✅ Не требует "разогрева" аккаунта

---

## Вариант 2: Яндекс.Почта (для .ru доменов)

Яндекс.Почта поддерживает SMTP для отправки писем и хорошо работает в России.

### Шаги настройки:

1. **Создайте почтовый ящик на Яндекс.Почте** (если еще нет):
   - Зайдите на https://mail.yandex.ru
   - Создайте аккаунт или используйте существующий

2. **Включите доступ почтовых клиентов** (КРИТИЧЕСКИ ВАЖНО!):
   - Откройте https://mail.yandex.ru
   - Нажмите на шестеренку ⚙️ (Настройки) в правом верхнем углу
   - Выберите "Все настройки"
   - Перейдите в раздел "Почтовые программы"
   - **ВКЛЮЧИТЕ** флажок "Разрешить доступ к почтовому ящику с помощью почтовых клиентов"
   - Сохраните изменения

3. **Включите "Пароли приложений"**:
   - Перейдите в https://id.yandex.ru/security
   - Найдите раздел "Пароли приложений"
   - Создайте новый пароль приложения (например, "Media Archive SMTP")
   - **Сохраните этот пароль** - он будет использоваться вместо обычного пароля

4. **Настройте переменные окружения**:

```bash
# SMTP настройки для Яндекс.Почты
SMTP_HOST=smtp.yandex.ru
SMTP_PORT=465
SMTP_SECURE=true
SMTP_USER=ваш_email@yandex.ru
SMTP_PASSWORD=пароль_приложения_из_шага_3
SMTP_FROM=ваш_email@yandex.ru

# Пример: если ваш email noreply@yandex.ru
SMTP_USER=noreply@yandex.ru
SMTP_PASSWORD=abcdefghijklmnop  # Пароль приложения, не ваш обычный пароль!
SMTP_FROM=noreply@yandex.ru
```

### Важные моменты:

- ✅ Используйте **пароль приложения**, а не обычный пароль аккаунта
- ✅ Порт 465 с `SMTP_SECURE=true` или порт 587 с `SMTP_SECURE=false`
- ✅ Отправитель (SMTP_FROM) должен совпадать с SMTP_USER
- ⚠️ Новые аккаунты могут блокировать письма как спам - нужен "разогрев"

---

## Вариант 3: Mail.ru

Mail.ru также поддерживает SMTP для отправки писем.

### Шаги настройки:

1. **Создайте почтовый ящик на Mail.ru**

2. **Включите двухфакторную аутентификацию**:
   - Перейдите в настройки безопасности
   - Включите 2FA

3. **Создайте пароль приложения**:
   - В настройках безопасности найдите "Пароли приложений"
   - Создайте пароль для SMTP

4. **Настройте переменные окружения**:

```bash
SMTP_HOST=smtp.mail.ru
SMTP_PORT=465
SMTP_SECURE=true
SMTP_USER=ваш_email@mail.ru
SMTP_PASSWORD=пароль_приложения
SMTP_FROM=ваш_email@mail.ru
```

---

## Вариант 4: Собственный почтовый сервер (для продвинутых)

Если у вас есть собственный домен и вы хотите отправлять письма с него, можно настроить свой SMTP сервер. Это сложнее и требует:

- Настроенный почтовый сервер (Postfix, Exim и т.д.)
- Правильные DNS записи (SPF, DKIM, DMARC)
- Защита от спама

**Не рекомендуется** для начала - используйте готовые сервисы.

---

## Настройка в Docker Compose

Добавьте переменные окружения в `docker-compose.prod.yml`:

```yaml
server:
  environment:
    # ... другие переменные
    SMTP_HOST: ${SMTP_HOST}
    SMTP_PORT: ${SMTP_PORT:-465}
    SMTP_SECURE: ${SMTP_SECURE:-true}
    SMTP_USER: ${SMTP_USER}
    SMTP_PASSWORD: ${SMTP_PASSWORD}
    SMTP_FROM: ${SMTP_FROM}
    EMAIL_VERIFICATION_TOKEN_TTL_HOURS: ${EMAIL_VERIFICATION_TOKEN_TTL_HOURS:-24}
```

Или создайте `.env` файл на сервере:

```bash
# .env на вашем VPS
SMTP_HOST=smtp.yandex.ru
SMTP_PORT=465
SMTP_SECURE=true
SMTP_USER=noreply@yandex.ru
SMTP_PASSWORD=ваш_пароль_приложения
SMTP_FROM=noreply@yandex.ru
FRONTEND_URL=https://ваш-домен.рф
```

---

## Проверка работы

После настройки проверьте работу:

1. Зарегистрируйте нового пользователя
2. Проверьте почту - должно прийти письмо с подтверждением
3. Если письмо не приходит, проверьте логи сервера:

```bash
docker compose logs server | grep -i email
```

В логах вы увидите:

- `Email отправлен успешно` - всё работает
- `SMTP не настроен` - проверьте переменные окружения
- Ошибки подключения - проверьте правильность настроек

---

## Безопасность

⚠️ **ВАЖНО:**

- Никогда не коммитьте пароли в git
- Используйте `.env` файлы, которые добавлены в `.gitignore`
- Используйте пароли приложений, а не основные пароли аккаунта
- Для продакшна используйте отдельный email для отправки (noreply@ваш-домен.рф)

---

## Troubleshooting

### Письма не приходят

1. **Проверьте логи сервера**:

   ```bash
   docker compose logs server
   ```

2. **Проверьте переменные окружения**:

   ```bash
   docker compose exec server env | grep SMTP
   ```

3. **Проверьте, что SMTP сервер доступен**:

   ```bash
   telnet smtp.yandex.ru 465
   ```

4. **В dev режиме письма не отправляются**, но логируются в консоль - это нормально

### Ошибка "Invalid login"

- Проверьте, что используете пароль приложения, а не основной пароль
- Убедитесь, что двухфакторная аутентификация включена

### Ошибка "Connection timeout"

- Проверьте, что порт не заблокирован firewall
- Попробуйте другой порт (587 вместо 465)
- Проверьте SMTP_SECURE (true для 465, false для 587)

---

## Рекомендации

✅ **Для продакшна рекомендуется Gmail** - надежная доставка, редко блокирует как спам

✅ **Создайте отдельный email** для отправки системных писем (например, noreply@gmail.com или noreply@yandex.ru)

✅ **Включите логирование** для отладки проблем

✅ **Тестируйте сначала локально** перед развертыванием на продакшн

✅ **Для Gmail**: используйте порт 587 с STARTTLS (SMTP_SECURE=false) - работает стабильнее
