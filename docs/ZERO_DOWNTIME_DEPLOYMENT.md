# Zero-Downtime Deployment

Этот документ описывает стратегию деплоя без простоя сервиса.

## Проблема

При стандартном деплое:

1. Останавливаются все контейнеры (`docker compose down`)
2. Собираются новые образы
3. Запускаются новые контейнеры

Это создает простой сервиса на время деплоя.

## Решение: Rolling Update

### Стратегия

1. **Сборка образов без остановки** - собираем новые образы, пока старые контейнеры работают
2. **Постепенное обновление** - обновляем сервисы по одному (сначала server, потом client)
3. **Health checks** - проверяем, что новый контейнер здоров перед остановкой старого
4. **Graceful shutdown** - даем время старым контейнерам завершить активные запросы

### Как это работает

```bash
# 1. Собираем новые образы (старые контейнеры продолжают работать)
docker compose -f docker-compose.prod.yml build

# 2. Обновляем server с проверкой health
docker compose -f docker-compose.prod.yml up -d --no-deps server
# Ждем пока новый server станет healthy
# Старый server автоматически останавливается после запуска нового

# 3. Обновляем client (после того как server готов)
docker compose -f docker-compose.prod.yml up -d --no-deps client
```

### Преимущества

- ✅ Нет простоя - старые контейнеры работают пока новые запускаются
- ✅ Автоматический rollback - если новый контейнер не проходит health check, старый продолжает работать
- ✅ Graceful shutdown - Docker Compose дает время на завершение соединений
- ✅ Простота - не требует дополнительной инфраструктуры

### Ограничения

- Требует достаточно ресурсов для одновременной работы двух версий (на короткое время)
- Миграции БД должны быть обратно совместимыми
- Health checks должны быть настроены правильно

## Альтернативные стратегии

### Blue-Green Deployment

Более сложная стратегия с двумя полными окружениями:

1. Запуск новой версии на отдельных портах
2. Проверка health новой версии
3. Переключение трафика через reverse proxy
4. Остановка старой версии

**Плюсы:** Полный контроль, можно тестировать новую версию перед переключением
**Минусы:** Требует больше ресурсов и настройки reverse proxy

### Canary Deployment

Постепенный перевод части трафика на новую версию:

1. Запуск новой версии
2. Переключение 10% трафика
3. Мониторинг метрик
4. Постепенное увеличение до 100%

**Плюсы:** Минимальный риск, можно быстро откатить
**Минусы:** Требует продвинутой инфраструктуры (Kubernetes, Istio и т.д.)

## Рекомендации

Для текущей инфраструктуры (Docker Compose на VPS) рекомендуется **Rolling Update**, так как:

1. Не требует дополнительной инфраструктуры
2. Просто в реализации
3. Обеспечивает zero-downtime для большинства случаев
4. Автоматически использует health checks

## Мониторинг

После деплоя проверяйте:

- Логи новых контейнеров
- Метрики производительности
- Health checks endpoints
- Ошибки в приложении

## Откат изменений

Если что-то пошло не так:

```bash
# Откат к предыдущему коммиту
git checkout <previous-commit>
docker compose -f docker-compose.prod.yml build
docker compose -f docker-compose.prod.yml up -d
```

Или используйте автоматический откат в GitHub Actions workflow.
