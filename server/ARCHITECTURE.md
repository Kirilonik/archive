# Слоистая архитектура backend-сервера

## Цели

- Разделить бизнес-логику, инфраструктурный код и интерфейс представления (HTTP), чтобы упростить тестирование, рефакторинг и расширение функциональности.
- Стандартизировать подход к работе с БД и внешними API.
- Создать основу для последующей модульности и внедрения доменно-ориентированного дизайна.

## Текущая структура

```
server/src/
  app/                   # HTTP-слой и интеграция адаптеров
    controllers/         # Обработчики маршрутов, принимающие/возвращающие DTO
    middlewares/
    routes/
  application/           # Сервисный слой (use cases)
    auth/
    films/
    series/
    seasons/
    episodes/
    users/
    stats/
  domain/                # Чистые сущности и интерфейсы репозиториев
    users/
      entities/
      repositories/
  infrastructure/        # Реализации репозиториев, интеграции с внешними сервисами
    database/
      repositories/
    integrations/
  shared/                # Общие утилиты, ошибки, типы
```

## Принципы

1. **Контроллеры** вызывают _application services_, валидируют входные данные и отвечают за формат HTTP-ответов.
2. **Application services (use cases)** инкапсулируют сценарии, вызывают репозитории и интеграции через абстракции domain-слоя.
3. **Domain** содержит чистые сущности, value objects, интерфейсы репозиториев и ошибки уровня домена. Не зависит от инфраструктуры.
4. **Infrastructure** реализует интерфейсы домена (например, PostgreSQL-репозитории), использует конкретные адаптеры (`pg`, `sharp`, внешние API).
5. **Shared** предоставляет общие инструменты: логирование, DI-контейнер, мапперы, ошибки.

## Состояние миграции

- **Слоистая схема завершена** для доменов `auth`, `users`, `films`, `series`, `seasons`, `episodes`, `stats`.
- Каждый модуль имеет:
  - доменные типы и интерфейсы (`domain/*`);
  - реализации репозиториев в `infrastructure/database/repositories`;
  - application-сервис с бизнес-логикой;
  - контроллеры и маршруты (HTTP-слой) с зависимостью от `authMiddleware`.
- DI-контейнер (`app/container.ts`) инстанцирует все сервисы и репозитории, упрощая подмену зависимостей в тестах.
- Интеграция с Kinopoisk оформлена клиентом `KinopoiskHttpClient` (infrastructure/integrations).

## Тестирование

- **Unit (Jest)**: сервисы из слоя `application` тестируются с моками репозиториев.
- **Integration (supertest + Jest)**: покрывают контроллеры `auth`, `users`, `films`, `series`, `seasons`, `episodes`, `stats`. Каждый тест эмулирует работу `authMiddleware`, проверяет happy-path и базовые негативные сценарии (401/403).
- Все тесты запускаются одной командой `npm run test` (включена в CI).
- Для ESM окружения установка глобального `jest` выполняется в `src/test/setup.ts`.

## Инфраструктура и миграции

- Подключение к PostgreSQL и `runMigrations` находятся в `config/db.ts` и `db/migrate.ts`; миграции защищены advisory-lock'ом.
- Docker Compose прокидывает необходимые переменные (`JWT_SECRET`, `API_BASE_URL` и т.п.) в сервисы `server` и `client`.
- Скрипты тестов и сборки запускаются в GitHub Actions workflow `.github/workflows/ci.yml`.

## Следующие шаги

- Стандартизировать нейминг DTO/сценариев (например, `GetUserProfileQuery`, `UpdateUserProfileCommand`).
- Расширить покрытие тестами для других вспомогательных модулей (поиск, уведомления) по готовому шаблону.
- Добавить eslint/tsconfig алиасы для удобного импорта слоёв.

