FROM node:20-alpine

WORKDIR /work

# Общая база TS
COPY tsconfig.base.json ./tsconfig.base.json

# Устанавливаем зависимости server
COPY server/package.json server/tsconfig.json ./server/
RUN cd server && npm ci || npm install

# Копируем исходники (будут перезаписаны volume mount, но нужны для первой сборки)
COPY server/src ./server/src

# Копируем скрипт запуска
COPY server/start-dev.sh /work/server/start-dev.sh
RUN chmod +x /work/server/start-dev.sh

WORKDIR /work/server
ENV NODE_ENV=development
EXPOSE 4000

# Используем скрипт запуска для hot reload
CMD ["/work/server/start-dev.sh"]

