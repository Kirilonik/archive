FROM node:20-alpine

# Устанавливаем curl для fallback запросов к внешним API
# Используем retry логику для надежной установки
RUN set -eux; \
    for i in 1 2 3; do \
        apk update --no-cache && \
        apk add --no-cache curl && break || \
        (echo "Attempt $i failed, retrying..." && sleep 10); \
    done

WORKDIR /work

# Общая база TS
COPY tsconfig.base.json ./tsconfig.base.json

# Устанавливаем зависимости server
COPY server/package.json server/tsconfig.json ./server/
RUN cd server && npm ci || npm install

# Копируем исходники (будут перезаписаны volume mount, но нужны для первой сборки)
COPY server/src ./server/src

# Копируем скрипт запуска
COPY server/start-dev.sh /work/server/start-dev.sh
RUN chmod +x /work/server/start-dev.sh

WORKDIR /work/server
ENV NODE_ENV=development
EXPOSE 4000

# Используем скрипт запуска для hot reload
CMD ["/work/server/start-dev.sh"]

