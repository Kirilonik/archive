## План перехода на регистрацию по номеру телефона с Яндекс капчей

### 1. Подготовка инфраструктуры и зависимостей

#### 1.1. Яндекс капча (SmartCaptcha)

- Зарегистрировать приложение в Яндекс Cloud и получить ключи (client key и server key)
- Добавить переменные окружения для капчи:
  - `YANDEX_SMARTCAPTCHA_CLIENT_KEY` — публичный ключ для клиента
  - `YANDEX_SMARTCAPTCHA_SERVER_KEY` — секретный ключ для сервера
- Установить пакет для валидации капчи на сервере (если нужен, или использовать прямые HTTP-запросы)

#### 1.2. SMS-сервис для отправки кодов

- Выбрать провайдера (SMS.ru, Twilio, Yandex Cloud SMS и т.п.)
- Получить API-ключи и настроить аккаунт
- Добавить переменные окружения:
  - `SMS_PROVIDER_API_KEY`
  - `SMS_PROVIDER_API_URL` (если требуется)
- Установить SDK/библиотеку для работы с выбранным SMS-провайдером

### 2. Изменения в базе данных

#### 2.1. Миграция для добавления полей телефона

- Создать миграцию для добавления в таблицу `users`:
  - `phone` VARCHAR(20) UNIQUE — номер телефона (в формате E.164: +79991234567)
  - `phone_verified` BOOLEAN DEFAULT false — статус подтверждения телефона
  - `email` сделать опциональным (NULL) или оставить для обратной совместимости
  - Индекс на `phone` для быстрого поиска

#### 2.2. Таблица для SMS-кодов верификации

- Создать таблицу `phone_verification_codes`:
  - `id` SERIAL PRIMARY KEY
  - `phone` VARCHAR(20) NOT NULL
  - `code` VARCHAR(6) NOT NULL — 6-значный код
  - `expires_at` TIMESTAMP WITH TIME ZONE NOT NULL
  - `created_at` TIMESTAMP WITH TIME ZONE DEFAULT NOW()
  - `used_at` TIMESTAMP WITH TIME ZONE NULL
  - `attempts` INTEGER DEFAULT 0 — счетчик попыток ввода
  - Индексы на `phone` и `expires_at` для очистки истекших кодов

#### 2.3. Обратная совместимость

- Решить, как обрабатывать существующих пользователей с email:
  - Вариант А: оставить email обязательным для старых пользователей
  - Вариант Б: сделать email опциональным для всех
  - Вариант В: миграция данных (если нужно)

### 3. Изменения на сервере (Backend)

#### 3.1. Доменные типы и интерфейсы

- Обновить `auth.types.ts`:
  - Добавить `phone` в `AuthUser` и `AuthUserWithPassword`
  - Добавить `phoneVerified` в `AuthUser`
  - Изменить `RegisterUserInput`: заменить `email` на `phone` или сделать оба опциональными
  - Добавить интерфейсы для SMS-верификации:
    - `PhoneVerificationCode` (аналог `EmailVerificationToken`)
    - `SendVerificationCodeInput` (phone)
    - `VerifyPhoneCodeInput` (phone, code)

#### 3.2. Репозиторий (AuthRepository)

- Обновить `AuthPgRepository`:
  - `findByPhone(phone: string)` — поиск по телефону
  - `createPhoneVerificationCode(phone, code, expiresAt)` — создание кода
  - `findPhoneVerificationCode(phone, code)` — поиск активного кода
  - `markPhoneVerificationCodeAsUsed(codeId)` — пометить код как использованный
  - `incrementVerificationAttempts(codeId)` — увеличить счетчик попыток
  - `deleteExpiredPhoneVerificationCodes()` — очистка истекших кодов
  - Обновить `createUser` для работы с `phone` вместо `email`
  - Обновить `findByEmail` (если email остается опциональным)

#### 3.3. SMS-сервис (новый)

- Создать `infrastructure/sms/sms.service.ts`:
  - Интерфейс `SmsService` с методом `sendVerificationCode(phone: string, code: string)`
  - Реализация для выбранного провайдера
  - Обработка ошибок и логирование
  - Rate limiting для предотвращения спама

#### 3.4. Сервис Яндекс капчи

- Создать `infrastructure/captcha/yandex-captcha.service.ts`:
  - Метод `verifyCaptcha(token: string, ip?: string)` — проверка токена капчи
  - HTTP-запрос к API Яндекс SmartCaptcha
  - Обработка ошибок и валидация ответа

#### 3.5. Обновление AuthService

- Изменить метод `register`:
  - Принимать `phone` вместо `email`
  - Проверять существование пользователя по телефону
  - Создавать пользователя с `phone_verified = false`
  - Не отправлять email, вместо этого отправлять SMS-код
- Добавить методы:
  - `sendPhoneVerificationCode(phone: string)` — отправка SMS-кода
  - `verifyPhoneCode(phone: string, code: string)` — проверка кода и подтверждение телефона
- Обновить `login`:
  - Поиск пользователя по телефону вместо email
  - Проверка `phoneVerified` вместо `emailVerified`
- Обновить `buildTokens`: использовать `phone` в payload JWT (если нужно)

#### 3.6. Обновление AuthController

- Изменить `register`:
  - Валидация телефона (формат E.164)
  - Проверка Яндекс капчи перед регистрацией
  - Принимать `phone` вместо `email` в схеме Zod
  - Принимать `captchaToken` в теле запроса
- Добавить endpoints:
  - `POST /api/auth/send-phone-code` — отправка SMS-кода
  - `POST /api/auth/verify-phone-code` — проверка кода
- Обновить `login`:
  - Принимать `phone` вместо `email`
  - Валидация формата телефона

#### 3.7. Обновление маршрутов

- Обновить `auth.routes.ts`:
  - Добавить маршруты для отправки и проверки SMS-кодов
  - Обновить существующие маршруты регистрации и входа

#### 3.8. Валидация номера телефона

- Создать утилиту для нормализации и валидации:
  - Приведение к формату E.164 (+79991234567)
  - Проверка корректности формата
  - Валидация длины и символов

#### 3.9. Rate limiting для SMS

- Добавить middleware для ограничения:
  - Количество запросов кода с одного IP
  - Количество попыток ввода кода с одного телефона
  - Использовать `express-rate-limit` или аналоги

### 4. Изменения на клиенте (Frontend)

#### 4.1. Установка Яндекс SmartCaptcha

- Добавить скрипт Яндекс SmartCaptcha в `index.html`
- Или использовать npm-пакет, если доступен

#### 4.2. Обновление компонента Register.tsx

- Заменить поле `email` на `phone`:
  - Input для номера телефона
  - Маска ввода (опционально)
  - Валидация формата на клиенте
- Добавить Яндекс капчу:
  - Виджет SmartCaptcha
  - Получение токена капчи перед отправкой формы
  - Передача токена в запросе регистрации
- Изменить логику регистрации:
  - После успешной регистрации переходить на страницу ввода SMS-кода
  - Передавать номер телефона в состояние

#### 4.3. Новая страница VerifyPhone.tsx

- Создать компонент для ввода SMS-кода:
  - Поле для 6-значного кода
  - Кнопка "Отправить код повторно" (с таймером)
  - Обработка успешной верификации
  - Редирект на страницу входа после подтверждения

#### 4.4. Обновление AuthContext

- Обновить `register`:
  - Принимать `phone` и `captchaToken` вместо `email`
  - Обновить тип `RegisterPayload`
- Обновить типы:
  - `AuthenticatedUser` — добавить `phone` и `phone_verified`
  - Убрать или сделать опциональным `email`

#### 4.5. Обновление страницы Login.tsx

- Заменить поле `email` на `phone`
- Обновить валидацию и обработку формы

#### 4.6. Обновление API-клиента

- Обновить `lib/api.ts`:
  - Методы для отправки и проверки SMS-кодов
  - Обновить типы запросов/ответов

### 5. Безопасность и защита

#### 5.1. Защита от брутфорса

- Ограничение попыток ввода SMS-кода (максимум 3–5 попыток)
- Блокировка телефона после превышения лимита (временная)
- Логирование подозрительных попыток

#### 5.2. Защита от спама SMS

- Rate limiting на отправку кодов:
  - Максимум 1 код в минуту с одного телефона
  - Максимум 5 кодов в час с одного IP
- Проверка капчи перед каждой отправкой SMS

#### 5.3. Валидация капчи

- Проверка капчи на сервере перед:
  - Регистрацией
  - Отправкой SMS-кода
  - Повторной отправкой кода

### 6. Миграция данных (если требуется)

#### 6.1. Обработка существующих пользователей

- Решить стратегию:
  - Оставить email-регистрацию для старых пользователей
  - Или мигрировать на телефон (если есть данные)
- Обновить логику входа: поддержка и email, и телефона (если нужно)

### 7. Тестирование

#### 7.1. Unit-тесты

- Тесты для валидации телефона
- Тесты для SMS-сервиса (моки)
- Тесты для капчи (моки)
- Тесты для AuthService с телефоном

#### 7.2. Интеграционные тесты

- Тесты регистрации с капчей
- Тесты отправки и проверки SMS-кода
- Тесты входа по телефону

#### 7.3. E2E-тесты (опционально)

- Полный флоу регистрации
- Проверка UI-компонентов

### 8. Документация и конфигурация

#### 8.1. Обновление переменных окружения

- Добавить новые переменные в `.env.example`
- Обновить документацию по настройке

#### 8.2. Обновление README

- Описание новой регистрации
- Инструкции по настройке SMS-провайдера
- Инструкции по настройке Яндекс капчи

### 9. UI/UX улучшения

#### 9.1. Улучшение UX

- Маска ввода телефона
- Автофокус на поле кода
- Визуальная обратная связь при отправке SMS
- Таймер обратного отсчета для повторной отправки
- Понятные сообщения об ошибках

### 10. Мониторинг и логирование

#### 10.1. Логирование

- Логирование отправки SMS
- Логирование проверки капчи
- Логирование попыток верификации
- Метрики успешности/неудач

#### 10.2. Алерты

- Алерты при сбоях SMS-провайдера
- Алерты при подозрительной активности
- Мониторинг rate limits

---

## Порядок реализации (рекомендуемый)

1. Фаза 1: Инфраструктура
   - Настройка Яндекс капчи
   - Настройка SMS-провайдера
   - Создание сервисов (SMS, капча)

2. Фаза 2: База данных
   - Миграции для телефона
   - Таблица для SMS-кодов

3. Фаза 3: Backend
   - Обновление типов и репозиториев
   - Обновление AuthService и Controller
   - Добавление endpoints для SMS

4. Фаза 4: Frontend
   - Обновление Register.tsx
   - Создание VerifyPhone.tsx
   - Интеграция капчи

5. Фаза 5: Тестирование и доработки
   - Тестирование всех сценариев
   - Исправление багов
   - Оптимизация

Этот план покрывает основные шаги перехода. Нужны уточнения по какому-то пункту?
